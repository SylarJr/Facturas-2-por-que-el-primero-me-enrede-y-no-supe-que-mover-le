@page "/VerFac"
@rendermode InteractiveServer
@using Facturas.Components.Data
@inject ServicioDeFacturas FacturasService

<h3>Historial de Facturas (Con Edición Automática)</h3>

@if (listaFacturas == null)
{
    <p><em>Cargando facturas...</em></p>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Artículos</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var fact in listaFacturas)
            {
                <tr>
                    <td>@fact.Identificador</td>
                    <td>@fact.Fecha.ToShortDateString()</td>
                    <td>@fact.Nombre</td>
                    <td><small>@fact.articulo</small></td>
                    <td>$@fact.total</td>
                    <td>
                        <button class="btn btn-warning btn-sm" @onclick="() => CargarParaEditar(fact)">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" @onclick="() => BorrarFactura(fact.Identificador)">
                            Eliminar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<hr />

@if (facturaEnEdicion != null)
{
    <div class="card border-warning mt-4 shadow">
        <div class="card-header bg-warning text-dark">
            <strong>Editando Factura #@facturaEnEdicion.Identificador</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Nombre Cliente:</label>
                    <input class="form-control" @bind="facturaEnEdicion.Nombre" />
                </div>
                <div class="col-md-3">
                    <label>Fecha:</label>
                    <input type="date" class="form-control" @bind="facturaEnEdicion.Fecha" />
                </div>
                <div class="col-md-3">
                    <label>Total (Automático):</label>
                    <input type="number" class="form-control" @bind="facturaEnEdicion.total" readonly style="background-color: #e9ecef;" />
                </div>
            </div>

            <hr />

            <h5>Editar Cantidades</h5>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Artículo</th>
                        <th style="width: 100px;">Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in itemsEdicion)
                    {
                        <tr>
                            <td>@item.Nombre</td>
                            <td>
                                <input type="number" class="form-control form-control-sm"
                                       @bind="item.Cantidad"
                                       @bind:after="RecalcularTotalEdicion"
                                       min="1" />
                            </td>
                            <td>$@item.Precio</td>
                            <td>$@(item.Cantidad* item.Precio)</td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="mt-3 text-end">
                <button class="btn btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
                <button class="btn btn-success" @onclick="GuardarCambios">Guardar Cambios</button>
            </div>
        </div>
    </div>
}

@code {
    List<Factura> listaFacturas = new List<Factura>();
    Factura? facturaEnEdicion = null;

    class ItemEditor
    {
        public string Nombre { get; set; } = "";
        public int Precio { get; set; }
        public int Cantidad { get; set; }
    }

    List<ItemEditor> itemsEdicion = new List<ItemEditor>();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    async Task CargarDatos()
    {
        listaFacturas = await FacturasService.obtenerFactura();
    }

    async Task BorrarFactura(int id)
    {
        await FacturasService.EliminarFactura(id);
        await CargarDatos();
    }


    void CargarParaEditar(Factura facturaSeleccionada)
    {
        facturaEnEdicion = new Factura
        {
            Identificador = facturaSeleccionada.Identificador,
            Nombre = facturaSeleccionada.Nombre,
            articulo = facturaSeleccionada.articulo,
            total = facturaSeleccionada.total,
            Fecha = facturaSeleccionada.Fecha
        };

        itemsEdicion.Clear();

        if (!string.IsNullOrEmpty(facturaEnEdicion.articulo))
        {
            try
            {
                var partes = facturaEnEdicion.articulo.Split(';'); 
                foreach (var parte in partes)
                {
                    if (string.IsNullOrWhiteSpace(parte)) continue;

                    
                    var splitX = parte.Trim().Split('x'); 
                    int cant = int.Parse(splitX[0]);

                    var resto = splitX[1];
                    var splitArroba = resto.Split('@');
                    string nombre = splitArroba[0].Trim();

                    
                    string precioStr = splitArroba[1].Replace("$", "").Trim();
                    int precio = int.Parse(precioStr);

                    itemsEdicion.Add(new ItemEditor { Cantidad = cant, Nombre = nombre, Precio = precio });
                }
            }
            catch
            {
                Console.WriteLine("Error al leer formato antiguo. Se mostrará vacío.");
            }
        }
    }

    
    void RecalcularTotalEdicion()
    {
        if (facturaEnEdicion != null)
        {
            
            facturaEnEdicion.total = itemsEdicion.Sum(x => x.Cantidad * x.Precio);
        }
    }

    async Task GuardarCambios()
    {
        if (facturaEnEdicion != null)
        {
          
            facturaEnEdicion.articulo = string.Join("; ", itemsEdicion.Select(x => $"{x.Cantidad}x {x.Nombre} @ ${x.Precio}"));

            await FacturasService.ModificarFactura(facturaEnEdicion);
            facturaEnEdicion = null;
            await CargarDatos();
        }
    }

    void CancelarEdicion()
    {
        facturaEnEdicion = null;
    }
}