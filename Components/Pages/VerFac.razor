@page "/VerFac"
@rendermode InteractiveServer
@using Facturas.Components.Data
@using System.Globalization
@inject ServicioDeFacturas FacturasService

<h3>Gestión y Reportes de Facturas</h3>

<div class="card mb-4 border-info">
    <div class="card-header bg-info text-white">
        <strong>Generar Reporte Mensual</strong>
    </div>
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-4">
                <label>Selecciona el Año:</label>
                <input type="number" class="form-control" @bind="anioReporte" />
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary" @onclick="GenerarReporte">
                    📄 Ver Reporte por Meses
                </button>
                <button class="btn btn-outline-secondary" @onclick="VerTodas">
                    👁 Ver Todo el Historial
                </button>
            </div>
        </div>
    </div>
</div>

@if (modoReporte)
{
  
    @if (reporteAgrupado.Count() == 0)
    {
        <div class="alert alert-warning">No se encontraron facturas en el año @anioReporte.</div>
    }
    else
    {
        @foreach (var grupoMes in reporteAgrupado)
        {
            <div class="card mb-3 shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="m-0 text-primary">📅 @ObtenerNombreMes(grupoMes.Key)</h4>
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered m-0">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Artículos</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var fact in grupoMes)
                            {
                                <tr>
                                    <td>@fact.Fecha.ToShortDateString()</td>
                                    <td>@fact.Nombre</td>
                                    <td><small>@fact.articulo</small></td>
                                    <td>$@fact.total</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-group-divider">
                            <tr class="table-secondary">
                                <td colspan="3" class="text-end"><strong>TOTAL DEL MES:</strong></td>
                                <td class="text-success"><strong>$@grupoMes.Sum(f => f.total)</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

        <div class="alert alert-success mt-3">
            <strong>GRAN TOTAL AÑO @anioReporte: $@reporteAgrupado.Sum(g => g.Sum(f => f.total))</strong>
        </div>
    }
}
else
{
   
    @if (listaFacturas == null)
    {
        <p><em>Cargando facturas...</em></p>
    }
    else
    {
        <h4>Historial Completo</h4>
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Artículos</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var fact in listaFacturas)
                {
                    <tr>
                        <td>@fact.Identificador</td>
                        <td>@fact.Fecha.ToShortDateString()</td>
                        <td>@fact.Nombre</td>
                        <td><small>@fact.articulo</small></td>
                        <td>$@fact.total</td>
                        <td>
                            <button class="btn btn-warning btn-sm" @onclick="() => CargarParaEditar(fact)">Editar</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => BorrarFactura(fact.Identificador)">Eliminar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (facturaEnEdicion != null)
{
    <hr />
    <div class="card border-warning mt-4 shadow">
        <div class="card-header bg-warning text-dark">
            <strong>Editando Factura #@facturaEnEdicion.Identificador</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Nombre Cliente:</label>
                    <input class="form-control" @bind="facturaEnEdicion.Nombre" />
                </div>
                <div class="col-md-3">
                    <label>Fecha:</label>
                    <input type="date" class="form-control" @bind="facturaEnEdicion.Fecha" />
                </div>
                <div class="col-md-3">
                    <label>Total (Automático):</label>
                    <input type="number" class="form-control" @bind="facturaEnEdicion.total" readonly style="background-color: #e9ecef;" />
                </div>
            </div>
            <hr />
            <h5>Editar Cantidades</h5>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Artículo</th>
                        <th style="width: 100px;">Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in itemsEdicion)
                    {
                        <tr>
                            <td>@item.Nombre</td>
                            <td>
                                <input type="number" class="form-control form-control-sm"
                                       @bind="item.Cantidad"
                                       @bind:after="RecalcularTotalEdicion"
                                       min="1" />
                            </td>
                            <td>$@item.Precio</td>
                            <td>$@(item.Cantidad* item.Precio)</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-3 text-end">
                <button class="btn btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
                <button class="btn btn-success" @onclick="GuardarCambios">Guardar Cambios</button>
            </div>
        </div>
    </div>
}

@code {
    List<Factura> listaFacturas = new List<Factura>();
    Factura? facturaEnEdicion = null;

   
    int anioReporte = DateTime.Now.Year;
    bool modoReporte = false; 


    IEnumerable<IGrouping<int, Factura>> reporteAgrupado = new List<IGrouping<int, Factura>>();


    class ItemEditor { public string Nombre { get; set; } = ""; public int Precio { get; set; } public int Cantidad { get; set; } }
    List<ItemEditor> itemsEdicion = new List<ItemEditor>();

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    async Task CargarDatos()
    {
        listaFacturas = await FacturasService.obtenerFactura();
      
        if (modoReporte) GenerarReporte();
    }


    void GenerarReporte()
    {
        modoReporte = true;

        reporteAgrupado = listaFacturas
            .Where(f => f.Fecha.Year == anioReporte)
            .GroupBy(f => f.Fecha.Month)
            .OrderBy(g => g.Key);
    }

    void VerTodas()
    {
        modoReporte = false;
    }

    string ObtenerNombreMes(int numeroMes)
    {
        return System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(numeroMes).ToUpper();
    }
    async Task BorrarFactura(int id)
    {
        await FacturasService.EliminarFactura(id);
        await CargarDatos();
    }

    void CargarParaEditar(Factura facturaSeleccionada)
    {
        facturaEnEdicion = new Factura
        {
            Identificador = facturaSeleccionada.Identificador,
            Nombre = facturaSeleccionada.Nombre,
            articulo = facturaSeleccionada.articulo,
            total = facturaSeleccionada.total,
            Fecha = facturaSeleccionada.Fecha
        };
        itemsEdicion.Clear();
        if (!string.IsNullOrEmpty(facturaEnEdicion.articulo))
        {
            try
            {
                var partes = facturaEnEdicion.articulo.Split(';');
                foreach (var parte in partes)
                {
                    if (string.IsNullOrWhiteSpace(parte)) continue;
                    var splitX = parte.Trim().Split('x');
                    int cant = int.Parse(splitX[0]);
                    var resto = splitX[1];
                    var splitArroba = resto.Split('@');
                    string nombre = splitArroba[0].Trim();
                    string precioStr = splitArroba[1].Replace("$", "").Trim();
                    int precio = int.Parse(precioStr);
                    itemsEdicion.Add(new ItemEditor { Cantidad = cant, Nombre = nombre, Precio = precio });
                }
            }
            catch { }
        }
    }

    void RecalcularTotalEdicion()
    {
        if (facturaEnEdicion != null) facturaEnEdicion.total = itemsEdicion.Sum(x => x.Cantidad * x.Precio);
    }

    async Task GuardarCambios()
    {
        if (facturaEnEdicion != null)
        {
            facturaEnEdicion.articulo = string.Join("; ", itemsEdicion.Select(x => $"{x.Cantidad}x {x.Nombre} @ ${x.Precio}"));
            await FacturasService.ModificarFactura(facturaEnEdicion);
            facturaEnEdicion = null;
            await CargarDatos();
        }
    }

    void CancelarEdicion() => facturaEnEdicion = null;
}